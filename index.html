<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>JXOS v1.3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --animation-speed: 1;
            --holo-blue: #33b5e5;
            --app-bg: #111;
            --dark-bg: #000;
            --item-pressed-bg: rgba(51, 181, 229, 0.2);
            --holo-green: #99cc00;
            --pink-accent: #c2185b;
        }
        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            background: #212121; font-family: 'Roboto', sans-serif; font-weight: 400; user-select: none;
        }
        .hidden { display: none !important; }

        #notification-popup {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(30,30,30,0.85); backdrop-filter: blur(5px);
            color: white; padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            z-index: 2000; font-size: 14px; opacity: 0; transition: opacity 0.5s, top 0.5s;
        }
        #notification-popup.show { opacity: 1; top: 40px; }

        #device-choice-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #device-choice-modal h2 { font-weight: 300; font-size: 22px; margin-bottom: 20px; }
        .choice-buttons button {
            background: transparent; color: white; border: 1px solid var(--holo-blue);
            padding: 12px 28px; margin: 10px; font-size: 16px;
            border-radius: 4px; cursor: pointer; transition: all 0.2s ease;
        }
        .choice-buttons button:hover { background: var(--holo-blue); color: var(--dark-bg); }

        body.pc-view { display:flex;align-items:center;justify-content:center; }
        body.pc-view #android-container { height: auto; border-radius: 24px; }
        body.pc-view #desktop { margin: 20px auto; }
        
        #boot-screen {
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            height: 100%; background: #000; color: #eee;
            font-family: monospace; font-size: 14px;
            padding: 20px; box-sizing: border-box; text-align: center;
        }
        .boot-header { color: var(--holo-green); font-size: 20px; font-weight: bold; margin-bottom: 20px; }
        .boot-info-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 5px 15px; text-align: left; }
        .boot-label { color: #aaa; }
        .boot-value { color: #fff; font-weight: bold; }
        .boot-value.red { color: #f44336; }
        .boot-value.yellow { color: #ffeb3b; }
        .boot-value.green { color: #4caf50; }
        
        #android-container {
            width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;
            transition: transform 0.3s ease;
        }
        #desktop {
            width: 360px; height: 640px; background-color: #000; background-size: cover; background-position: center;
            position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.6);
            overflow: hidden; display: flex; flex-direction: column;
        }
        
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            height: 25px; display: flex; justify-content: flex-end; align-items: center;
            padding: 0 8px; color: #fff; font-size: 14px; font-weight: 500;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.9);
            background: rgba(0,0,0,0.6); z-index: 10; box-sizing: border-box;
        }

        #app-grid {
            flex-grow: 1; padding: 20px; margin-top: 25px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; align-content: start;
        }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .app-icon img {
            width: 58px; height: 58px; border-radius: 12px; margin-bottom: 8px;
            transition: all calc(0.2s * var(--animation-speed));
        }
        .app-icon[data-installed="false"] img { filter: grayscale(1); opacity: 0.6; }
        .app-icon[data-installed="false"]:hover img { transform: none; box-shadow: none; }
        .app-icon:not([data-installed="false"]):hover img { transform: scale(1.1); box-shadow: 0 0 15px rgba(51, 181, 229, 0.5); }
        .app-icon span { color: #fff; font-size: 13px; text-shadow: 1px 1px 2px rgba(0,0,0,0.9); text-align: center; }

        #nav-bar {
            height: 48px; background: #000; flex-shrink: 0; display: flex; justify-content: space-around; align-items: center;
            z-index: 25; position: relative;
        }
        .nav-btn {
            background: none; border: none; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;
            flex-grow: 1; height: 100%; display: flex; justify-content: center; align-items: center;
        }
        .nav-btn:hover { opacity: 1; background: var(--item-pressed-bg); }
        .nav-btn svg { width: 26px; height: 26px; }
        
        #physical-power-button {
            position: absolute; right: -5px; top: 120px; width: 5px; height: 80px; z-index: 50; cursor: pointer;
        }

        #app-window {
            position: absolute; top: 25px; left: 0; width: 100%; height: calc(100% - 25px - 48px);
            background: var(--app-bg); display: flex; flex-direction: column; z-index: 20;
            transform-origin: center; animation: openApp calc(0.35s * var(--animation-speed)) forwards cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        @keyframes openApp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        #app-window.closing { animation: closeApp calc(0.3s * var(--animation-speed)) forwards ease-in-out; }
        @keyframes closeApp { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
        
        .app-header {
            background: #222; border-bottom: 2px solid var(--holo-blue);
            color: #fff; padding: 12px 16px; text-align: left;
            font-weight: 400; font-size: 20px; flex-shrink: 0;
            display: flex; align-items: center; gap: 10px;
        }
        
        #app-content { flex-grow: 1; overflow-y: auto; color: #fff; }
        #app-content::-webkit-scrollbar { width: 5px; }
        #app-content::-webkit-scrollbar-track { background: transparent; }
        #app-content::-webkit-scrollbar-thumb { background: var(--holo-blue); border-radius: 2px; }

        #aod-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 900; color: #777; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #aod-time { font-size: 72px; font-weight: 300; }
        #aod-date { font-size: 18px; font-weight: 400; }
    </style>
</head>
<body>
    
    <div id="notification-popup"></div>

    <div id="device-choice-modal">
        <h2>Как вы просматриваете сайт?</h2>
        <div class="choice-buttons">
            <button id="pc-choice">С компьютера</button>
            <button id="mobile-choice">С телефона</button>
        </div>
    </div>
    
    <div id="boot-screen" class="hidden">
        <div class="boot-header">-- JXOS Recovery Mode --</div>
        <div class="boot-info-grid">
            <div class="boot-label">PRODUCT NAME:</div>    <div class="boot-value">JX-MIDO</div>
            <div class="boot-label">CURRENT BINARY:</div>  <div class="boot-value">JXOS Official</div>
            <div class="boot-label">SYSTEM STATUS:</div>   <div class="boot-value">Official</div>
            <div class="boot-label">FRP LOCK:</div>         <div class="boot-value">OFF</div>
            <div class="boot-label">OEM LOCK:</div>         <div id="bootloader-status" class="boot-value">Lock</div>
            <div class="boot-label">ROOT STATUS:</div>      <div id="root-status" class="boot-value">No</div>
            <div class="boot-label">SECURE DOWNLOAD:</div>  <div class="boot-value green">ENABLED</div>
            <div class="boot-label">SERIAL:</div>           <div class="boot-value">MIDO-18PQ-JXXS</div>
            <div class="boot-label">SOC:</div>               <div class="boot-value">MT-6673</div>
        </div>
    </div>

    <div id="android-container" class="hidden">
        <div id="desktop">
            <div id="status-bar"><span id="time">12:00</span></div>
            
            <div id="aod-screen" class="hidden">
                <div id="aod-time">12:00</div>
                <div id="aod-date">Sunday, 1 January</div>
            </div>

            <main id="app-grid">
                <div class="app-icon" data-app="JMail" data-installed="false"><img src="icons/jmail.png" alt="JMail"><span>JMail</span></div>
                <div class="app-icon" data-app="Magisk"><img src="icons/magisk.png" alt="Magisk"><span>Magisk</span></div>
                <div class="app-icon" data-app="JxMarket"><img src="icons/market.png" alt="JxMarket"><span>JxMarket</span></div>
                <div class="app-icon" data-app="Player"><img src="icons/mp3.png" alt="MP3 Player"><span>MP3 Player</span></div>
                <div class="app-icon" data-app="Gallery"><img src="icons/gallery.png" alt="Gallery"><span>Gallery</span></div>
                <div class="app-icon" data-app="Settings"><img src="icons/settings.png" alt="Настройки"><span>Настройки</span></div>
                <div class="app-icon" data-app="FlappyBird"><img src="icons/flappy.png" alt="Flappy Bird"><span>Flappy Bird</span></div>
                <div class="app-icon" data-app="Terminal"><img src="icons/terminal.png" alt="Terminal"><span>Terminal</span></div>
                <div class="app-icon" data-app="JxPartition"><img src="icons/info.png" alt="Разделы"><span>Разделы</span></div>
                <div class="app-icon" data-app="JxManager" data-installed="false"><img src="icons/up.png" alt="JxManager"><span>JxManager</span></div>
                <div class="app-icon" data-app="Browser"><img src="icons/market.png" alt="Browser"><span>Browser</span></div>
            </main>

            <div id="app-window" class="hidden">
                <div id="app-header-container"></div>
                <div id="app-content"></div>
            </div>

            <div id="nav-bar">
                <button class="nav-btn" id="back-btn" title="Back"><svg viewBox="0 0 24 24"><path fill="white" d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg></button>
                <button class="nav-btn" id="home-btn" title="Home"><svg viewBox="0 0 24 24"><path fill="white" d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg></button>
                <button class="nav-btn" id="recents-btn" title="Recents"><svg viewBox="0 0 24 24"><path fill="white" d="M18,18H6V6H18V18M18,4H6C4.89,4 4,4.89 4,6V18A2,2 0 0,0 6,20H18A2,2 0 0,0 20,18V6C20,4.89 19.1,4 18,4Z" /></svg></button>
            </div>
            <div id="physical-power-button"></div>
        </div>
    </div>

    <script>
    'use strict';
    
    let clickAudio, playerAudio, powerPressTimer, notificationTimeout;
    let isScreenOff = false;
    let currentAppName = null;

    function showNotification(message) {
        const popup = document.getElementById('notification-popup');
        if (notificationTimeout) clearTimeout(notificationTimeout);
        popup.textContent = message;
        popup.classList.add('show');
        notificationTimeout = setTimeout(() => popup.classList.remove('show'), 3000);
    }

    (function checkSystemStatusOnBoot() {
        const bootloaderStatusElem = document.getElementById('bootloader-status');
        const rootStatusElem = document.getElementById('root-status');
        if(!bootloaderStatusElem) return;
        const isUnlocked = localStorage.getItem('bootloader_unlocked') === 'true';
        const isRooted = localStorage.getItem('is_rooted') === 'true';
        bootloaderStatusElem.textContent = isUnlocked ? 'Unlock' : 'Lock';
        bootloaderStatusElem.classList.toggle('yellow', isUnlocked);
        bootloaderStatusElem.classList.toggle('red', !isUnlocked);
        rootStatusElem.textContent = isRooted ? 'Yes' : 'No';
        rootStatusElem.classList.toggle('yellow', isRooted);
    })();

    function rebootDevice(fast = false) {
        document.getElementById('android-container')?.style.setProperty('opacity', '0');
        setTimeout(() => window.location.reload(), fast ? 100 : 500);
    }
    
    const allEmails = [
        { id: 1, sender: 'Jelikton', subject: 'Добро пожаловать в JXOS!', preview: 'Мы рады видеть вас в нашей новой ОС...', body: 'Добро пожаловать в JXOS v1.3!\n\nЭто эмулятор операционной системы, созданный для демонстрации. Вы можете исследовать приложения, изменять настройки и даже получать ROOT-права.\n\nУдачи!', read: true },
        { id: 2, sender: 'Happy Farm', subject: 'Ваши посевы готовы!', preview: 'Срочно зайдите в игру, чтобы собрать урожай.', body: 'Привет, фермер!\n\nТвоя пшеница созрела. Не дай ей пропасть! Заходи в игру и собери свой урожай, чтобы освободить место для новых культур.', read: false, spam: true },
        { id: 3, sender: 'GitHub', subject: 'New issue in JXOS', preview: 'User reported a kernel panic...', body: 'User @testdummy reported a kernel panic when playing Flappy Bird for more than 30 minutes. Need to investigate memory leaks.', read: true },
        { id: 4, sender: 'Нигерийский Принц', subject: 'СРОЧНОЕ ДЕЛОВОЕ ПРЕДЛОЖЕНИЕ', preview: 'Мое имя Абу, и мне нужна ваша помощь...', body: 'Здравствуйте, достопочтенный друг.\n\nМое имя - Принц Абубакар Тунде. Я обращаюсь к вам с этим срочным и конфиденциальным деловым предложением. Мне нужна ваша помощь в переводе 10,000,000 долларов США, которые я унаследовал от своего покойного отца.', read: false, spam: true },
        ...Array.from({length: 56}, (_, i) => ({ id: 5+i, sender: `Spammer${i+1}`, subject: 'Увеличьте ваш... доход!', preview: 'Самый лучший способ заработать не выходя из дома!', body: 'Это спам-сообщение номер ' + (i+1) + '. Пожалуйста, не отвечайте на него.', read: false, spam: true }))
    ];
    
    const appRenderers = {
        JMail: (container) => {
            let emails = JSON.parse(localStorage.getItem('jmail_emails'));
            if (!emails) {
                emails = allEmails.slice(0, 5);
                localStorage.setItem('jmail_emails', JSON.stringify(emails));
                localStorage.setItem('jmail_last_email_id', 5);
            }
            const originalLength = emails.length;
            emails = emails.filter(e => !e.spam);
            if (emails.length !== originalLength) {
                localStorage.setItem('jmail_emails', JSON.stringify(emails));
            }
            const replyTemplatesById = {
                1: ['Спасибо за тёплый приём!', 'С чего лучше начать?', 'Где найти руководство пользователя?'],
                2: ['Зайду и соберу урожай', 'Сделаю позже', 'Отключить подобные уведомления'],
                3: ['Dude, dont write me about this shit', 'Solution: build a new kernel', 'иди нахуй'],
                4: ['Не интересует', 'Удалите мой адрес из рассылки', 'Сообщить о мошенничестве']
            };
            const getReplyOptions = (email) => {
                if (replyTemplatesById[email.id]) return replyTemplatesById[email.id];
                if (email.spam) {
                    return [
                        `Отписаться от ${email.sender}`,
                        `Не писать по теме: ${email.subject}`,
                        'Пожаловаться на спам'
                    ];
                }
                return [
                    `Спасибо, ${email.sender}!`,
                    `Ознакомлюсь: ${email.subject}`,
                    'Свяжусь позже',
                    'Давайте обсудим детали'
                ];
            };
            const lastReceived = parseInt(localStorage.getItem('jmail_last_received_time') || '0');
            const nextEmailId = parseInt(localStorage.getItem('jmail_last_email_id') || '5');
            if (Date.now() - lastReceived > 30000 && nextEmailId < allEmails.length) {
                let pointer = nextEmailId;
                let added = false;
                while (pointer < allEmails.length) {
                    const candidate = allEmails[pointer];
                    pointer++;
                    if (candidate.spam) continue;
                    emails.unshift(candidate);
                localStorage.setItem('jmail_emails', JSON.stringify(emails));
                    if (currentAppName !== 'JMail') showNotification(`Новое сообщение от: ${candidate.sender}`);
                    added = true;
                    break;
                }
                localStorage.setItem('jmail_last_email_id', pointer);
                localStorage.setItem('jmail_last_received_time', Date.now());
            }
            function renderEmailDetail(emailId) {
                const email = emails.find(e => e.id === emailId);
                if (!email) { renderEmailList(); return; }
                email.read = true;
                localStorage.setItem('jmail_emails', JSON.stringify(emails));
                document.getElementById('app-header-container').innerHTML = `<div class="app-header" style="cursor: pointer;display:flex;align-items:center;gap:10px;">
                    <div id="back-to-maillist" style="display:flex;align-items:center;gap:10px;">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="var(--holo-blue)" d="M17.77 3.77L16 2 6 12l10 10 1.77-1.77L9.54 12z"/></svg>
                        <span>${email.subject}</span>
                    </div>
                    <button id="delete-email-btn" style="margin-left:auto;background:#c62828;color:#fff;border:0;border-radius:4px;padding:6px 10px;cursor:pointer">Удалить</button>
                </div>`;
                document.getElementById('back-to-maillist').onclick = renderEmailList;
                const deleteBtn = document.getElementById('delete-email-btn');
                if (deleteBtn) {
                    deleteBtn.onclick = () => {
                        if (!confirm('Удалить это письмо?')) return;
                        emails = emails.filter(e => e.id !== emailId);
                        localStorage.setItem('jmail_emails', JSON.stringify(emails));
                        showNotification('Письмо удалено');
                        renderEmailList();
                    };
                }
                const replyOptions = getReplyOptions(email);
                const canReply = email.id !== 1;
                container.innerHTML = `<style>
                .email-detail-sender{font-size:16px;color:#ccc;padding:15px;border-bottom:1px solid #333}
                .email-detail-body{padding:20px;font-size:16px;line-height:1.6;white-space:pre-wrap;color:#eee}
                .reply-toggle{padding:10px 15px;border-top:1px solid #222}
                .reply-toggle button{background:var(--holo-blue);color:#fff;border:0;border-radius:4px;padding:8px 14px;cursor:pointer}
                .reply-box{padding:10px 15px;border-top:1px solid #222}
                .reply-options{display:flex;flex-wrap:wrap;gap:8px}
                .reply-option-btn{background:#444;color:#fff;border:1px solid #333;border-radius:16px;padding:8px 12px;cursor:pointer}
                .reply-option-btn.selected{background:var(--holo-blue);border-color:var(--holo-blue);color:#000}
                .reply-actions{display:flex;gap:10px;margin-top:10px}
                .reply-actions button{border:0;border-radius:4px;padding:8px 14px;cursor:pointer}
                #send-reply-btn{background:var(--holo-green);color:#000}
                #send-reply-btn:disabled{opacity:.5;cursor:not-allowed}
                #cancel-reply-btn{background:#444;color:#fff}
                .reply-disabled{padding:10px 15px;border-top:1px solid #222;color:#aaa}
                .email-reply{margin:0 15px 15px;padding:12px;border:1px solid #333;border-radius:6px;background:#151515;color:#ddd}
                .email-reply-title{font-size:13px;color:#aaa;margin-bottom:8px}
                .email-reply-body{white-space:pre-wrap;color:#eee;font-size:15px}
                .email-reply-meta{margin-top:6px;font-size:12px;color:#888}
                </style>
                <div class="email-detail-sender">От: <b>${email.sender}</b></div>
                <div class="email-detail-body">${email.body}</div>
                <div id="reply-view"></div>
                ${canReply ? `
                <div class=\"reply-toggle\"><button id=\"reply-btn\">Ответить</button></div>
                <div id=\"reply-box\" class=\"reply-box hidden\">
                    <div class=\"reply-options\">
                        ${replyOptions.map(opt => `<button class=\"reply-option-btn\" data-value=\"${opt.replace(/\\"/g,'&quot;').replace(/"/g,'&quot;')}\">${opt}</button>`).join('')}
                    </div>
                    <div class=\"reply-actions\">
                        <button id=\"send-reply-btn\" disabled>Отправить</button>
                        <button id=\"cancel-reply-btn\">Отмена</button>
                    </div>
                </div>
                ` : `
                <div class=\"reply-disabled\"></div>
                `}`;
                const escapeHtml = (s) => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const updateReplyView = () => {
                    const replyView = container.querySelector('#reply-view');
                    if (!replyView) return;
                    const sent = JSON.parse(localStorage.getItem('jmail_sent') || '[]');
                    const last = sent.find(r => r.to === email.sender && r.subject === 'Re: ' + email.subject);
                    if (last) {
                        const when = new Date(last.date).toLocaleString('ru-RU');
                        replyView.innerHTML = `<div class="email-reply"><div class="email-reply-title">Ваш ответ</div><div class="email-reply-body">${escapeHtml(last.body)}</div><div class="email-reply-meta">Отправлено: ${when}</div></div>`;
                    } else {
                        replyView.innerHTML = '';
                    }
                };
                updateReplyView();
                if (canReply) {
                    const replyBox = container.querySelector('#reply-box');
                    const replyBtn = container.querySelector('#reply-btn');
                    const cancelBtn = container.querySelector('#cancel-reply-btn');
                    const sendBtn = container.querySelector('#send-reply-btn');
                    let selectedReply = null;
                    replyBtn.onclick = () => { replyBox.classList.remove('hidden'); };
                    cancelBtn.onclick = () => { replyBox.classList.add('hidden'); selectedReply = null; sendBtn.disabled = true; container.querySelectorAll('.reply-option-btn').forEach(b=>b.classList.remove('selected')); };
                    container.querySelectorAll('.reply-option-btn').forEach(btn => {
                        btn.onclick = () => {
                            selectedReply = btn.dataset.value;
                            container.querySelectorAll('.reply-option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            sendBtn.disabled = false;
                        };
                    });
                    sendBtn.onclick = () => {
                        if (!selectedReply) { showNotification('Выберите вариант ответа'); return; }
                        const sent = JSON.parse(localStorage.getItem('jmail_sent') || '[]');
                        const lastId = (parseInt(localStorage.getItem('jmail_sent_last_id') || '0') + 1);
                        sent.unshift({ id: lastId, to: email.sender, subject: 'Re: ' + email.subject, body: selectedReply, date: Date.now() });
                        localStorage.setItem('jmail_sent', JSON.stringify(sent));
                        localStorage.setItem('jmail_sent_last_id', String(lastId));
                        showNotification('Ответ отправлен');
                        selectedReply = null;
                        sendBtn.disabled = true;
                        replyBox.classList.add('hidden');
                    updateReplyView();
                    };
                }
            }
            function renderEmailList() {
                document.getElementById('app-header-container').innerHTML = `<div class="app-header"><span>JMail</span></div>`;
                container.innerHTML = `<style>.email-list{padding:0;margin:0;list-style:none}.email-item{display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #222;cursor:pointer}.email-item:hover{background:var(--item-pressed-bg)}.email-item.unread .email-sender,.email-item.unread .email-subject{font-weight:500;color:#fff}.email-avatar{width:40px;height:40px;border-radius:50%;background:#333;display:flex;justify-content:center;align-items:center;font-size:20px;font-weight:bold;margin-right:15px;flex-shrink:0}.email-content{flex-grow:1;overflow:hidden}.email-sender{font-size:16px;color:#eee}.email-subject,.email-preview{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#ccc}.email-preview{font-size:12px;color:#888}</style><ul class="email-list">${emails.map(email => `<li class="email-item ${!email.read?'unread':''}" data-id="${email.id}"><div class="email-avatar" style="background-color:${email.spam?'#c62828':'#1976d2'}">${email.sender.charAt(0)}</div><div class="email-content"><div class="email-sender">${email.sender}</div><div class="email-subject">${email.subject}</div><div class="email-preview">${email.preview}</div></div></li>`).join('') || '<p style="text-align:center;padding:40px">Нет сообщений</p>'}</ul>`;
                container.querySelectorAll('.email-item').forEach(item => item.onclick = () => renderEmailDetail(parseInt(item.dataset.id)));
            }
            renderEmailList();
        },
        JxMarket: (container) => {
            const account = JSON.parse(localStorage.getItem('jx_account') || 'null');
            const jmailInstalled = localStorage.getItem('jmail_installed') === 'true';
            let buttonText = jmailInstalled ? 'ОТКРЫТЬ' : 'СКАЧАТЬ';
            let buttonClass = jmailInstalled ? 'open' : 'download';

            const renderAuth = () => {
                container.innerHTML = `<style>
                .market-header{padding:12px 0;text-align:center;color:var(--holo-blue);font-weight:500;border-bottom:3px solid var(--holo-blue);font-size:16px}
                .auth-wrap{padding:16px}
                .auth-field{display:flex;flex-direction:column;margin-bottom:10px}
                .auth-field label{font-size:12px;color:#aaa;margin-bottom:6px}
                .auth-input{background:#111;border:1px solid #333;border-radius:4px;color:#fff;padding:8px}
                .auth-actions{display:flex;gap:10px;margin-top:10px}
                .btn{border:0;border-radius:4px;padding:8px 12px;cursor:pointer}
                .btn-primary{background:var(--holo-blue);color:#fff}
                </style>
                <div class="market-header">JxMarket — Вход</div>
                <div class="auth-wrap">
                    <div class="auth-field">
                        <label>Логин</label>
                        <input id="auth-login" class="auth-input" placeholder="Введите логин">
                    </div>
                    <div class="auth-field">
                        <label>Пароль</label>
                        <input id="auth-pass" type="password" class="auth-input" placeholder="Введите пароль">
                    </div>
                    <div class="auth-actions">
                        <button id="auth-submit" class="btn btn-primary">Войти</button>
                    </div>
                    <div id="auth-msg" style="margin-top:8px;color:#aaa"></div>
                </div>`;
                const msg = container.querySelector('#auth-msg');
                container.querySelector('#auth-submit').onclick = () => {
                    const login = (container.querySelector('#auth-login')||{}).value?.trim();
                    const pass = (container.querySelector('#auth-pass')||{}).value?.trim();
                    if (!login || !pass) { msg.textContent = 'Введите логин и пароль'; return; }
                    localStorage.setItem('jx_account', JSON.stringify({ login, createdAt: Date.now() }));
                    showNotification('Вход выполнен');
                    renderMarket();
                };
            };

            const renderMarket = () => {
                const isFrpLocked = localStorage.getItem('jx_frp_locked') === 'true';
                if (isFrpLocked) {
                    container.innerHTML = `<div style="padding:16px;color:#ff8a80">FRP LOCK: устройство заблокировано из-за привязанного аккаунта после сброса. Для разблокировки требуется вручную удалить 4 корректных файла из 1000.</div>`;
                    return;
                }
                const isLoggedIn = !!localStorage.getItem('jx_account');
                if (!isLoggedIn) { renderAuth(); return; }
                container.innerHTML = `<style>.market-header{padding:12px 0;text-align:center;color:var(--holo-blue);font-weight:500;border-bottom:3px solid var(--holo-blue);font-size:16px}.app-list-item{display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #222}.app-list-icon{width:50px;height:50px;margin-right:15px;border-radius:8px;background:#333;display:flex;justify-content:center;align-items:center}.app-list-icon img{width:28px;height:28px}.app-list-info{flex-grow:1}.app-list-name{font-size:16px}.app-list-details{font-size:12px;color:#aaa}.app-install-button{border:none;border-radius:4px;padding:8px 16px;font-weight:500;cursor:pointer}.app-install-button.download{background:var(--holo-green);color:#000}.app-install-button.open{background:var(--holo-blue);color:#fff}.progress-bar{width:100%;height:4px;background:#555;border-radius:2px;margin-top:5px;display:none}.progress-bar-inner{width:0%;height:100%;background:var(--holo-green);border-radius:2px;transition:width 0.1s linear}.auth-info{padding:8px 16px;color:#aaa;border-bottom:1px solid #222}</style><div class="market-header">All Apps</div><div class="auth-info">Аккаунт: ${(JSON.parse(localStorage.getItem('jx_account')||'{}').login)||''}</div><div>
                <div class="app-list-item"><div class="app-list-icon"><img src="icons/jmail.png" alt="JMail Icon"></div><div class="app-list-info"><div class="app-list-name">JMail</div><div class="app-list-details">JXOS Devs</div><div class="progress-bar"><div class="progress-bar-inner"></div></div></div><button class="app-install-button ${buttonClass}" id="jmail-install-btn">${buttonText}</button></div>
                <div class="app-list-item"><div class="app-list-icon"><img src="icons/up.png" alt="JxManager Icon"></div><div class="app-list-info"><div class="app-list-name">JxManager</div><div class="app-list-details">JXOS Tools</div><div class="progress-bar"><div class="progress-bar-inner"></div></div></div><button class="app-install-button ${localStorage.getItem('jxmanager_installed')==='true'?'open':'download'}" id="jxmanager-install-btn">${localStorage.getItem('jxmanager_installed')==='true'?'ОТКРЫТЬ':'СКАЧАТЬ'}</button></div>
                </div>`;

                const installBtn = container.querySelector('#jmail-install-btn');
                installBtn.onclick = () => {
                    if (localStorage.getItem('jmail_installed') === 'true') {
                        document.querySelector('.app-icon[data-app="JMail"]').click();
                    } else {
                        installBtn.disabled = true; installBtn.textContent = 'ЗАГРУЗКА...';
                        const progressBar = container.querySelector('.progress-bar'), progressBarInner = container.querySelector('.progress-bar-inner');
                        progressBar.style.display = 'block';
                        let progress = 0;
                        const interval = setInterval(() => {
                            progress += 5;
                            progressBarInner.style.width = `${progress}%`;
                            if (progress >= 100) {
                                clearInterval(interval);
                                localStorage.setItem('jmail_installed', 'true');
                                installBtn.textContent = 'ОТКРЫТЬ';
                                installBtn.className = 'app-install-button open';
                                installBtn.disabled = false;
                                document.querySelector('.app-icon[data-app="JMail"]').dataset.installed = 'true';
                            }
                        }, 100);
                    }
                };
                const jxManagerBtn = container.querySelector('#jxmanager-install-btn');
                jxManagerBtn.onclick = () => {
                    if (localStorage.getItem('jxmanager_installed') === 'true') {
                        document.querySelector('.app-icon[data-app="JxManager"]').dataset.installed = 'true';
                        document.querySelector('.app-icon[data-app="JxManager"]').click();
                    } else {
                        jxManagerBtn.disabled = true; jxManagerBtn.textContent = 'ЗАГРУЗКА...';
                        const box = jxManagerBtn.closest('.app-list-item');
                        const progressBar = box.querySelector('.progress-bar'), progressBarInner = box.querySelector('.progress-bar-inner');
                        progressBar.style.display = 'block';
                        let progress = 0;
                        const interval = setInterval(() => {
                            progress += 5;
                            progressBarInner.style.width = `${progress}%`;
                            if (progress >= 100) {
                                clearInterval(interval);
                                localStorage.setItem('jxmanager_installed', 'true');
                                jxManagerBtn.textContent = 'ОТКРЫТЬ';
                                jxManagerBtn.className = 'app-install-button open';
                                jxManagerBtn.disabled = false;
                                document.querySelector('.app-icon[data-app="JxManager"]').dataset.installed = 'true';
                            }
                        }, 100);
                    }
                };
            };

            renderMarket();
        },
        Settings: (container) => {
            const headerContainer = document.getElementById('app-header-container');
            const renderSettingsMain = () => {
                headerContainer.innerHTML = `<div class="app-header"><span>Настройки</span></div>`;
                container.innerHTML = `<style>.settings-list{list-style:none;padding:0;margin:0}.settings-item{display:flex;align-items:center;padding:15px;border-bottom:1px solid #222;cursor:pointer;transition:background-color .2s}.settings-item:hover{background-color:var(--item-pressed-bg)}.settings-icon{width:24px;height:24px;margin-right:15px;opacity:.8}.settings-text{flex-grow:1;font-size:16px;color:#fff}.settings-category-header{font-size:14px;font-weight:500;color:var(--holo-blue);padding:15px 15px 8px;text-transform:uppercase;border-bottom:1px solid #222}.danger{color:#ff8a80}</style><ul class="settings-list"><li class="settings-category-header">Устройство</li><li class="settings-item" data-menu="display"><img src="icons/display.png" class="settings-icon"><div class="settings-text">Экран</div></li><li class="settings-item" data-menu="sounds"><img src="icons/sound.png" class="settings-icon"><div class="settings-text">Звуки</div></li><li class="settings-item" data-menu="about"><img src="icons/info.png" class="settings-icon"><div class="settings-text">О телефоне</div></li><li class="settings-item" data-menu="factory"><img src="icons/up.png" class="settings-icon"><div class="settings-text danger">Сброс игры</div></li></ul>`;
                container.querySelectorAll('.settings-item[data-menu]').forEach(btn => btn.onclick = (e) => renderSubmenu(e.currentTarget.dataset.menu));
            };
            const renderSubmenu = (menu) => {
                let content = '', title = '';
                const backButtonHTML = `<div class="app-header" style="cursor:pointer;" id="back-to-settings"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="var(--holo-blue)" d="M17.77 3.77L16 2 6 12l10 10 1.77-1.77L9.54 12z"/></svg><span id="app-title"></span></div>`;
                const submenuStyle = `<style>.submenu-item{padding:15px 20px;border-bottom:1px solid #222}.submenu-item label{display:block;margin-bottom:10px;font-size:16px}.wallpaper-previews{display:flex;gap:10px;margin-top:10px}.wallpaper-thumb{width:60px;height:100px;border:3px solid transparent;cursor:pointer;border-radius:6px;object-fit:cover;transition:border-color .2s}.wallpaper-thumb.selected{border-color:var(--holo-blue)}.switch{position:relative;display:inline-block;width:50px;height:24px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#555;transition:.4s;border-radius:24px}.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--holo-blue)}input:checked+.slider:before{transform:translateX(26px)}</style>`;
                
                switch(menu) {
                    case 'display':
                        title = "Экран";
                        content = `${submenuStyle}<div class="submenu-item"><label>Обои</label><div class="wallpaper-previews">${['wp1.jpg','wp2.jpg','wp3.jpg','wp4.jpg', 'wp5.jpg'].map(wp=>`<img src="images/${wp}" data-wp="images/${wp}" class="wallpaper-thumb">`).join('')}</div></div><div class="submenu-item"><label for="anim-speed">Скорость анимации</label><input type="range" id="anim-speed" min="0.1" max="5" step="0.1" value="${localStorage.getItem('animation_speed')||1}"></div>`;
                        break;
                    case 'sounds':
                        title = "Звуки";
                        const soundEnabled = localStorage.getItem('sound_enabled') !== 'false', soundVolume = parseFloat(localStorage.getItem('sound_volume')) || 0.5;
                        content = `${submenuStyle}<div class="submenu-item" style="display:flex;justify-content:space-between;align-items:center"><label style="margin:0">Звук нажатия</label><label class="switch"><input type="checkbox" id="sound-toggle" ${soundEnabled?'checked':''}><span class="slider"></span></label></div><div class="submenu-item"><label for="sound-volume">Громкость</label><input type="range" id="sound-volume" min="0" max="1" step="0.1" value="${soundVolume}"></div>`;
                        break;
                    case 'about':
                        title = "О телефоне";
                        content = `<div style="text-align:center;padding-top:30px"><h3>JXOS v1.3</h3><p>Версия сборки: Final</p><p>Разработчик: Jelikton</p></div>`;
                        break;
                    case 'factory':
                        title = 'Сброс игры';
                        content = `<div style="padding:16px">
                            <div style="color:#ff8a80;margin-bottom:10px;">Внимание! Будут удалены все сохранения и настройки.</div>
                            <button id="do-factory" style="background:#c62828;color:#fff;border:0;border-radius:6px;padding:10px 14px;cursor:pointer">Сбросить</button>
                        </div>`;
                        break;
                }
                headerContainer.innerHTML = backButtonHTML;
                document.getElementById('app-title').textContent = title;
                container.innerHTML = content;
                document.getElementById('back-to-settings').onclick = renderSettingsMain;
                
                if (menu === 'display') {
                    container.querySelectorAll('.wallpaper-thumb').forEach(thumb => {
                        if (thumb.dataset.wp === (localStorage.getItem('desktop_wallpaper') || 'images/wp1.jpg')) thumb.classList.add('selected');
                        thumb.onclick = () => {
                            const newWp = thumb.dataset.wp;
                            localStorage.setItem('desktop_wallpaper', newWp);
                            document.getElementById('desktop').style.backgroundImage = `url('${newWp}')`;
                            container.querySelector('.wallpaper-thumb.selected')?.classList.remove('selected');
                            thumb.classList.add('selected');
                        };
                    });
                    container.querySelector('#anim-speed').oninput = (e) => { localStorage.setItem('animation_speed', e.target.value); document.documentElement.style.setProperty('--animation-speed', e.target.value); };
                }
                if (menu === 'sounds') {
                    container.querySelector('#sound-toggle').onchange = (e) => localStorage.setItem('sound_enabled', e.target.checked);
                    container.querySelector('#sound-volume').oninput = (e) => { localStorage.setItem('sound_volume', e.target.value); if(clickAudio) clickAudio.volume = e.target.value; };
                }
                if (menu === 'factory') {
                    const doFactory = container.querySelector('#do-factory');
                    if (doFactory) doFactory.onclick = () => {
                        if (!confirm('Удалить ВСЕ данные и перезапустить?')) return;
                        const keysToKeep = ['view_mode'];
                        const preserve = {};
                        keysToKeep.forEach(k => { const v = localStorage.getItem(k); if (v !== null) preserve[k] = v; });
                        localStorage.clear();
                        Object.entries(preserve).forEach(([k,v]) => localStorage.setItem(k, v));
                        showNotification('Сброс выполнен');
                        setTimeout(() => rebootDevice(true), 600);
                    };
                }
            };
            renderSettingsMain();
        },
        Player: (container) => {
            const songMetadata = { "1.mp3": { title: "fine night", artist: "goreshit", duration: 204 }, "2.mp3": { title: "dreamer", artist: "goreshit", duration: 185 }, "3.mp3": { title: "hold my hand", artist: "goreshit", duration: 221 } };
            const songList = Object.keys(songMetadata);
            let currentTrackIndex = 0;

            container.innerHTML = `<style>.player-body{display:flex;flex-direction:column;height:100%;background:#1e1e1e}.player-main-content{flex-grow:1;background:#111;background-image:url(cover.jpg);background-size:cover;background-position:center}.player-controls-panel{background:var(--pink-accent);padding:10px 15px;color:#fff}.player-song-info{text-align:center;margin-bottom:10px}#song-title{font-size:18px;font-weight:500}#song-artist{font-size:12px;opacity:.8}.player-seek-controls{display:flex;align-items:center;gap:10px;font-size:12px}#seek-slider{flex-grow:1;-webkit-appearance:none;appearance:none;height:4px;background:rgba(0,0,0,.3);outline:none;border-radius:2px}#seek-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;background:#fff;border-radius:50%;cursor:pointer}.player-buttons{display:flex;justify-content:center;align-items:center;gap:30px;margin-top:10px}.player-buttons button{background:0;border:0;color:#fff;font-size:24px;font-weight:700;cursor:pointer}.player-playlist{max-height:150px;overflow-y:auto;background:#1e1e1e;border-top:1px solid #333}.player-playlist::-webkit-scrollbar{width:5px}.player-playlist::-webkit-scrollbar-track{background:#1e1e1e}.player-playlist::-webkit-scrollbar-thumb{background:#555;border-radius:2px}.playlist-item{padding:12px 15px;border-bottom:1px solid #333;cursor:pointer}.playlist-item.active{background:var(--holo-blue);color:#000;font-weight:500}</style><div class="player-body"><div class="player-main-content"></div><div class="player-controls-panel"><div class="player-song-info"><div id="song-title"></div><div id="song-artist"></div></div><div class="player-seek-controls"><span id="current-time">0:00</span><input type="range" id="seek-slider" value="0"><span id="total-time">0:00</span></div><div class="player-buttons"><button id="prev-btn">⏮</button><button id="play-pause-btn">▶</button><button id="next-btn">⏭</button></div></div><div id="playlist-container" class="player-playlist"></div></div>`;
            
            const titleElem = container.querySelector('#song-title'), artistElem = container.querySelector('#song-artist'),
                  currentTimeElem = container.querySelector('#current-time'), totalTimeElem = container.querySelector('#total-time'),
                  seekSlider = container.querySelector('#seek-slider'), playPauseBtn = container.querySelector('#play-pause-btn'),
                  playlistContainer = container.querySelector('#playlist-container');
            
            playerAudio = new Audio();
            const formatTime = s => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;

            const loadTrack = (index) => {
                currentTrackIndex = index;
                const songFile = songList[index], meta = songMetadata[songFile];
                playerAudio.src = `music/${songFile}`;
                titleElem.textContent = meta.title;
                artistElem.textContent = meta.artist;
                seekSlider.max = meta.duration;
                totalTimeElem.textContent = formatTime(meta.duration);
                updatePlaylistUI();
            };

            const playTrack = () => { playerAudio.play(); playPauseBtn.textContent = '⏸'; };
            const pauseTrack = () => { playerAudio.pause(); playPauseBtn.textContent = '▶'; };
            const updatePlaylistUI = () => container.querySelectorAll('.playlist-item').forEach((item, i) => item.classList.toggle('active', i === currentTrackIndex));
            
            songList.forEach((song, i) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.textContent = songMetadata[song].title;
                item.onclick = () => { loadTrack(i); playTrack(); };
                playlistContainer.appendChild(item);
            });
            
            playPauseBtn.onclick = () => (playerAudio.paused ? playTrack() : pauseTrack());
            container.querySelector('#next-btn').onclick = () => { loadTrack((currentTrackIndex + 1) % songList.length); playTrack(); };
            container.querySelector('#prev-btn').onclick = () => { loadTrack((currentTrackIndex - 1 + songList.length) % songList.length); playTrack(); };
            playerAudio.addEventListener('timeupdate', () => { seekSlider.value = playerAudio.currentTime; currentTimeElem.textContent = formatTime(playerAudio.currentTime); });
            playerAudio.addEventListener('ended', () => container.querySelector('#next-btn').click());
            seekSlider.addEventListener('input', () => playerAudio.currentTime = seekSlider.value);
            
            loadTrack(0);
        },
        Terminal: (container) => {
            container.innerHTML = `<style>.terminal{background:#000;height:100%;padding:10px;font-family:monospace;font-size:14px;display:flex;flex-direction:column-reverse;box-sizing:border-box}.terminal-output{flex-grow:1;overflow-y:auto;color:#0f0;word-break:break-all}.terminal-input-line{display:flex;background:#111;padding:5px}.terminal-input-line span{color:var(--holo-blue);padding-right:5px}.terminal-input{background:0;border:0;color:#0f0;flex-grow:1;font-family:monospace;font-size:14px;outline:0}</style><div class="terminal"><div class="terminal-input-line"><span>user@jxos:~$</span><input type="text" class="terminal-input" autofocus></div><div class="terminal-output"><div>(c) 2025 Jelikton Corp.</div><div>JXOS AOSP Terminal [Version 1.3]</div></div></div>`;
            const output = container.querySelector('.terminal-output'), input = container.querySelector('.terminal-input');
            const writeLine = (text, color = '#0f0') => { output.innerHTML = `<div style="color:${color};white-space:pre-wrap;">${text.replace(/</g,"&lt;")}</div>` + output.innerHTML; };
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    const cmd = input.value.trim(), args = cmd.split(' '), command = args[0];
                    writeLine(`user@jxos:~$ ${cmd}`, '#fff');
                    switch(command) {
                        case 'sudo':
                            if (args[1]==='unlock'&&args[2]==='oem'&&args[3]==='bootloader') {
                                writeLine('Attempting to unlock bootloader...');
                                setTimeout(() => {
                                    localStorage.setItem('bootloader_unlocked', 'true');
                                    const hasAccount = !!localStorage.getItem('jx_account');
                                    if (hasAccount) localStorage.setItem('jx_frp_locked', 'true');
                                    writeLine('oem bootloader unlock... [OKAY]', '#0f0');
                                    writeLine('Device will reboot in 5 seconds.');
                                    setTimeout(() => rebootDevice(true), 5000);
                                }, 2000);
                            } else writeLine('sudo: unknown command', '#f44336');
                            break;
                        case 'neofetch': writeLine('    _______   JXOS v1.3\n   /  _ \\ \\  OS: JXOS 1.3 (Holo)\n   | (L) | |  Kernel: 3.4.0-jelikton\n   \\_  < | |  Uptime: 1 min\n     \\ \\ / /   Shell: bash 4.2.2\n      \\_ /_/    CPU: MT-6673\n               GPU: Mali-400 MP', 'var(--holo-blue)'); break;
                        case 'ls': writeLine('images/ icons/ music/ photos/ index.html'); break;
                        case 'echo': writeLine(args.slice(1).join(' ')); break;
                        case 'reboot': writeLine('Rebooting...'); setTimeout(rebootDevice, 1000); break;
                        case 'clear': output.innerHTML = ''; break;
                        case 'help': writeLine('Commands: neofetch, ls, echo, reboot, clear, sudo'); break;
                        default: if(command) writeLine(`bash: command not found: ${command}`, '#f44336');
                    }
                    input.value = '';
                }
            };
        },
        Magisk: (container) => {
            const isRooted = localStorage.getItem('is_rooted') === 'true';
            const isBootloaderLocked = localStorage.getItem('bootloader_unlocked') !== 'true';
            container.innerHTML = `<style>.magisk-list-item{display:flex;align-items:center;padding:15px;border-bottom:1px solid #333}.magisk-item-icon{font-size:24px;margin-right:15px}.magisk-item-info{flex-grow:1}.magisk-item-title{font-size:16px;font-weight:500}.magisk-item-details{font-size:12px;color:#aaa}.magisk-install-btn{background:#555;color:#fff;border:0;padding:8px 18px;font-size:14px;border-radius:4px;cursor:pointer}.magisk-install-btn.installed{background:var(--holo-blue)}.magisk-footer{padding:20px;text-align:center;color:#aaa;font-size:14px}.magisk-footer.fail{color:#f44336}</style><div><div class="magisk-list-item"><div class="magisk-item-icon">⚡️</div><div class="magisk-item-info"><div class="magisk-item-title">Magisk</div><div class="magisk-item-details">${isRooted?'Installed: v25.2':'Not installed'}</div></div><button id="install-btn" class="magisk-install-btn ${isRooted?'installed':''}">${isRooted?'Установлено':'Install'}</button></div></div><div id="magisk-message" class="magisk-footer"></div>`;
            const installBtn = container.querySelector('#install-btn'), message = container.querySelector('#magisk-message');
            if (isRooted) message.textContent = 'Ваше устройство уже рутировано.';
            else if (isBootloaderLocked) { message.textContent = 'Загрузчик заблокирован! Разблокируйте его в терминале.'; message.classList.add('fail'); installBtn.disabled = true; }
            else {
                message.textContent = 'Нажмите Install для получения ROOT-прав.';
                installBtn.onclick = () => {
                    if (confirm('ВЫ ПОЛУЧИТЕ РУТ-ПРАВА НА СВОЕМ УСТРОЙСТВЕ?')) { localStorage.setItem('is_rooted', 'true'); message.textContent = 'Установка... Успешно! Перезагрузка...'; installBtn.disabled = true; setTimeout(rebootDevice, 4000); }
                };
            }
        },
        Gallery: (container) => {
            const photoList = ["photos/1.png", "photos/2.png", "photos/3.jpg"];
            container.innerHTML = `<style>.gallery-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;padding:5px}.gallery-thumb{width:100%;height:115px;object-fit:cover;cursor:pointer}.gallery-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:100;display:flex;justify-content:center;align-items:center}.gallery-modal img{max-width:90%;max-height:90%}</style><div class="gallery-grid"></div><div id="gallery-modal" class="gallery-modal hidden"><img id="full-photo" src=""></div>`;
            const grid = container.querySelector('.gallery-grid'), modal = container.querySelector('#gallery-modal'), fullPhoto = container.querySelector('#full-photo');
            if (!photoList.length) { grid.innerHTML = '<p style="padding:20px;text-align:center;grid-column:1/-1;">Нет фото.</p>'; return; }
            photoList.forEach(photoName => { const img = document.createElement('img'); img.src = photoName; img.className = 'gallery-thumb'; img.onclick = () => { fullPhoto.src = photoName; modal.classList.remove('hidden'); }; grid.appendChild(img); });
            modal.onclick = () => modal.classList.add('hidden');
        },
        FlappyBird: (container) => {
            container.innerHTML = `<style>#flappy-canvas{display:block;touch-action:none;background:#87ceeb;width:100%;height:100%}</style><canvas id="flappy-canvas"></canvas>`;
            const canvas = container.querySelector('#flappy-canvas');
            canvas.width = 360; canvas.height = container.clientHeight;
            const ctx = canvas.getContext('2d');
            let state = 'getReady', lastTime = 0, animationFrameId;
            const birdImg = new Image(); birdImg.src = "icons/flappy.png";
            const bird = { x: 80, y: 250, radius: 15, velocity: 0, gravity: 900, jumpStrength: -350, rotation: 0,
                draw: function() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation); ctx.drawImage(birdImg, -this.radius*1.2, -this.radius*1.2, this.radius*2.4, this.radius*2.4); ctx.restore(); },
                update: function(dt) {
                    if (state === 'getReady') { this.y = 250 + 8 * Math.sin(performance.now()/200); this.rotation = 0; }
                    else { this.velocity += this.gravity*dt; this.y += this.velocity*dt; this.rotation = this.velocity < 0 ? -Math.PI/6 : Math.min(Math.PI/2, this.rotation + 3*dt); if (this.y+this.radius >= canvas.height - 112) { this.y = canvas.height-112-this.radius; if (state === 'game') state = 'over'; } }
                }, jump: function() { this.velocity = this.jumpStrength; }, reset: function() { this.velocity = 0; this.y = 250; this.rotation = 0; }
            };
            const pipes = { position: [], w: 60, gap: 140, spawnInterval: 1.5, timer: 0, speed: 120,
                draw: function() { ctx.fillStyle="#008000"; for (let p of this.position) { ctx.fillRect(p.x, 0, this.w, p.y); ctx.fillRect(p.x, p.y+this.gap, this.w, canvas.height); } },
                update: function(dt) {
                    if (state !== 'game') return; this.timer += dt;
                    if (this.timer > this.spawnInterval) { this.timer = 0; this.position.push({ x: canvas.width, y: Math.random()*(canvas.height-this.gap-200)+100, passed: false }); }
                    for (let i = this.position.length - 1; i >= 0; i--) { let p = this.position[i]; p.x -= this.speed*dt; if (bird.x+bird.radius > p.x && bird.x-bird.radius < p.x+this.w && (bird.y-bird.radius < p.y || bird.y+bird.radius > p.y+this.gap)) { state = 'over'; } if (p.x+this.w < bird.x && !p.passed) { score.value++; p.passed = true; } if (p.x+this.w < 0) this.position.splice(i, 1); }
                }, reset: function() { this.position = []; this.timer = 0; }
            };
            const score = { value: 0,
                draw: function() { ctx.fillStyle="#FFF"; ctx.strokeStyle="#000"; ctx.lineWidth=2; ctx.font="35px sans-serif"; ctx.textAlign="center"; if (state === 'game') { ctx.fillText(this.value, canvas.width/2, 50); ctx.strokeText(this.value, canvas.width/2, 50); } else if (state === 'over') { ctx.fillText(`Score: ${this.value}`, canvas.width/2, canvas.height/2); } },
                reset: function() { this.value = 0; }
            };
            function draw() { ctx.fillStyle="#87ceeb"; ctx.fillRect(0, 0, canvas.width, canvas.height); pipes.draw(); ctx.fillStyle="#ded895"; ctx.fillRect(0, canvas.height - 112, canvas.width, 112); bird.draw(); score.draw(); if (state === 'getReady') { ctx.fillStyle="rgba(0,0,0,0.5)"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="white"; ctx.fillText("Нажмите чтобы начать", canvas.width/2, canvas.height/2); } }
            function loop(currentTime) { if (lastTime === 0) lastTime = currentTime; const deltaTime = (currentTime - lastTime)/1000; lastTime = currentTime; bird.update(deltaTime); pipes.update(deltaTime); draw(); animationFrameId = requestAnimationFrame(loop); }
            canvas.onclick = () => { switch(state) { case 'getReady': state='game'; bird.jump(); break; case 'game': bird.jump(); break; case 'over': state='getReady'; bird.reset(); pipes.reset(); score.reset(); break; } };
            loop(0);
            const observer = new MutationObserver(() => { if (document.getElementById('app-window').classList.contains('hidden')) { cancelAnimationFrame(animationFrameId); observer.disconnect(); } });
            observer.observe(document.getElementById('app-window'), { attributes: true });
        },
        JxManager: (container) => {
            const isRooted = localStorage.getItem('is_rooted') === 'true';
            container.innerHTML = `<style>
            .mgr-header{padding:12px 16px;border-bottom:1px solid #222;color:#ccc}
            .mgr-card{margin:12px 16px;border:1px solid #333;border-radius:8px;overflow:hidden}
            .mgr-card-header{padding:10px 12px;background:#111;color:#fff;border-bottom:1px solid #333}
            .mgr-card-body{padding:12px;color:#ddd}
            .mgr-actions{display:flex;gap:10px;margin-top:10px}
            .btn{border:0;border-radius:4px;padding:8px 12px;cursor:pointer}
            .btn-primary{background:var(--holo-blue);color:#fff}
            .btn-danger{background:#c62828;color:#fff}
            .note{color:#aaa;font-size:12px;margin-top:6px}
            </style>
            <div class="mgr-header">JxManager</div>
            <div class="mgr-card">
                <div class="mgr-card-header">Recovery: TWRP</div>
                <div class="mgr-card-body">
                    <div id="twrp-status">Статус: ${localStorage.getItem('twrp_installed')==='true' ? 'Установлено' : 'Не установлено'}</div>
                    <div class="mgr-actions">
                        <button id="install-twrp" class="btn btn-primary">Установить TWRP</button>
                        <button id="remove-twrp" class="btn btn-danger">Удалить TWRP</button>
                        <button id="reboot-twrp" class="btn btn-primary">Перезагрузить в TWRP</button>
                    </div>
                    <div class="note">Для установки требуется ROOT и разблокированный загрузчик.</div>
                </div>
            </div>`;
            const status = container.querySelector('#twrp-status');
            const updateStatus = () => status.textContent = `Статус: ${localStorage.getItem('twrp_installed')==='true' ? 'Установлено' : 'Не установлено'}`;
            container.querySelector('#install-twrp').onclick = () => {
                const bootloaderUnlocked = localStorage.getItem('bootloader_unlocked') === 'true';
                if (!isRooted) { showNotification('Нужен ROOT'); return; }
                if (!bootloaderUnlocked) { showNotification('Разблокируйте загрузчик'); return; }
                showNotification('Установка TWRP...');
                setTimeout(()=>{ localStorage.setItem('twrp_installed','true'); updateStatus(); showNotification('TWRP установлено'); }, 1200);
            };
            container.querySelector('#remove-twrp').onclick = () => {
                if (!isRooted) { showNotification('Нужен ROOT'); return; }
                localStorage.removeItem('twrp_installed'); updateStatus(); showNotification('TWRP удалено');
            };
            container.querySelector('#reboot-twrp').onclick = () => {
                if (localStorage.getItem('twrp_installed') !== 'true') { showNotification('Сначала установите TWRP'); return; }
                localStorage.setItem('reboot_to_twrp', 'true');
                showNotification('Перезагрузка в TWRP...');
                setTimeout(() => rebootDevice(true), 600);
            };
        },
        TWRP: (container) => {
            container.innerHTML = `<style>
            .twrp-header{padding:12px 16px;border-bottom:2px solid var(--holo-blue);color:#fff}
            .twrp-tabs{display:flex;border-bottom:1px solid #333}
            .twrp-tab{flex:1;text-align:center;padding:10px;cursor:pointer;color:#ccc}
            .twrp-tab.active{color:#fff;background:#111}
            .twrp-body{padding:12px 16px;color:#ddd}
            .file-row{display:flex;justify-content:space-between;align-items:center;border:1px solid #333;border-radius:6px;padding:8px 10px;margin-bottom:8px}
            .btn{border:0;border-radius:4px;padding:6px 10px;cursor:pointer}
            .btn-primary{background:var(--holo-blue);color:#fff}
            .btn-danger{background:#c62828;color:#fff}
            .muted{color:#aaa}
            .zip-ok{color:#99cc00}
            .zip-bad{color:#ff8a80}
            </style>
            <div class="twrp-header">Team Win Recovery Project (симуляция)</div>
            <div class="twrp-tabs">
                <div class="twrp-tab active" data-tab="install">Установка</div>
                <div class="twrp-tab" data-tab="wipe">Wipe</div>
                <div class="twrp-tab" data-tab="reboot">Перезагрузка</div>
            </div>
            <div id="twrp-content" class="twrp-body"></div>`;

            const content = container.querySelector('#twrp-content');
            const setActive = (tab) => {
                container.querySelectorAll('.twrp-tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
            };
            const renderInstall = () => {
                const zips = JSON.parse(localStorage.getItem('downloaded_zips')||'[]');
                if (!zips.length) { content.innerHTML = '<div class="muted">Нет загруженных прошивок. Загрузите .zip через Browser.</div>'; return; }
                content.innerHTML = zips.map((z,i)=>`<div class="file-row"><div>${z.name} <span class="${z.valid?'zip-ok':'zip-bad'}">${z.valid?'VALID':'CORRUPT'}</span></div><div><button class="btn btn-primary" data-i="${i}" data-action="flash" ${z.valid?'':'disabled'}>Прошить</button><button class="btn btn-danger" data-i="${i}" data-action="del">Удалить</button></div></div>`).join('');
                content.onclick = (e) => {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    const idx = parseInt(btn.dataset.i);
                    let list = JSON.parse(localStorage.getItem('downloaded_zips')||'[]');
                    if (btn.dataset.action==='del') {
                        list.splice(idx,1); localStorage.setItem('downloaded_zips', JSON.stringify(list)); renderInstall();
                    } else if (btn.dataset.action==='flash') {
                        const zip = list[idx];
                        showNotification(`Прошивка ${zip.name}...`);
                        setTimeout(()=>{
                            localStorage.setItem('desktop_wallpaper', 'images/wp4.jpg');
                            localStorage.setItem('rom_version', zip.name.replace(/\.zip$/i,''));
                            showNotification('Прошивка успешно установлена');
                        }, 1200);
                    }
                };
            };
            const renderWipe = () => {
                content.innerHTML = `<div class="muted">Wipe Data/Cache (симуляция)</div><div style="margin-top:10px"><button id="wipe-data" class="btn btn-danger">Wipe Data</button> <button id="wipe-cache" class="btn btn-danger">Wipe Cache</button></div>`;
                content.querySelector('#wipe-data').onclick = () => { showNotification('Data очищены'); };
                content.querySelector('#wipe-cache').onclick = () => { showNotification('Cache очищен'); };
            };
            const renderReboot = () => {
                content.innerHTML = `<button id="reboot-system" class="btn btn-primary">Reboot System</button>`;
                content.querySelector('#reboot-system').onclick = () => rebootDevice(true);
            };
            renderInstall();
            container.querySelectorAll('.twrp-tab').forEach(tab => tab.onclick = () => { setActive(tab.dataset.tab); ({install:renderInstall, wipe:renderWipe, reboot:renderReboot})[tab.dataset.tab](); });
        },
        Browser: (container) => {
            container.innerHTML = `<style>
            .br-header{padding:12px 16px;border-bottom:2px solid var(--holo-blue);color:#fff}
            .br-note{padding:10px 16px;color:#aaa}
            .br-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:10px;padding:10px 16px}
            .br-card{border:1px solid #333;border-radius:8px;overflow:hidden}
            .br-card h4{margin:0;padding:10px 12px;background:#111;border-bottom:1px solid #333}
            .br-card .body{padding:10px 12px;color:#ddd}
            .btn{border:0;border-radius:4px;padding:6px 10px;cursor:pointer}
            .btn-primary{background:var(--holo-blue);color:#fff}
            .badge{font-size:12px;color:#aaa;margin-left:6px}
            </style>
            <div class="br-header">Browser — кастомные прошивки</div>
            <div class="br-note">Скачайте .zip прошивку и установите её через TWRP.</div>
            <div class="br-grid" id="rom-list"></div>`;
            const roms = [
                { name:'LineageOS-18.1.zip', valid:true, desc:'Android 11, стабильная' },
                { name:'PixelDust-12L.zip', valid:true, desc:'Android 12L, бета' },
                { name:'MIUI-Pro-10.zip', valid:false, desc:'Повреждённый архив' }
            ];
            const list = container.querySelector('#rom-list');
            roms.forEach((r, idx)=>{
                const card = document.createElement('div');
                card.className = 'br-card';
                card.innerHTML = `<h4>${r.name}<span class="badge">${r.valid?'VALID':'CORRUPT'}</span></h4><div class="body">${r.desc}<div style="margin-top:8px"><button class="btn btn-primary" data-i="${idx}">Скачать</button></div></div>`;
                list.appendChild(card);
            });
            list.onclick = (e) => {
                const btn = e.target.closest('button[data-i]');
                if (!btn) return;
                const r = roms[parseInt(btn.dataset.i)];
                const zips = JSON.parse(localStorage.getItem('downloaded_zips')||'[]');
                if (zips.some(z=>z.name===r.name)) { showNotification('Уже скачано'); return; }
                showNotification('Загрузка...');
                setTimeout(()=>{ zips.push({ name:r.name, valid:r.valid }); localStorage.setItem('downloaded_zips', JSON.stringify(zips)); showNotification('Скачано'); }, 700);
            };
        },
        JxPartition: (container) => {
            const isRooted = localStorage.getItem('is_rooted') === 'true';
            container.innerHTML = `<style>
            .part-header{padding:12px 16px;border-bottom:1px solid #222;color:#ccc}
            .part-warning{background:#2a0000;color:#ff8a80;border:1px solid #b71c1c;margin:10px 15px;padding:10px;border-radius:6px;font-size:13px}
            .part-list{list-style:none;margin:10px 0 0;padding:0}
            .part-item{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #222}
            .part-name{flex:1;color:#fff}
            .part-tag{font-size:12px;color:#aaa}
            .danger{color:#ff5252}
            .part-actions button{border:0;border-radius:4px;padding:6px 10px;cursor:pointer}
            .btn-del{background:#c62828;color:#fff}
            .btn-opt{background:#1976d2;color:#fff}
            .muted{opacity:.7}
            </style>
            <div class="part-header">Управление разделами</div>
            <div class="part-warning">Внимание: требуется ROOT. Удаление разделов может привести к окирпичиванию устройства или неожиданному улучшению производительности. Используйте с осторожностью.</div>
            <ul class="part-list" id="part-list"></ul>`;
            if (!isRooted) {
                container.querySelector('#part-list').innerHTML = '<li class="part-item"><div class="part-name muted">Недостаточно прав. Установите ROOT в Magisk.</div></li>';
                return;
            }
            const defaultPartitions = [
                { key: 'boot', name: 'boot', critical: true },
                { key: 'system', name: 'system', critical: true },
                { key: 'vendor', name: 'vendor', critical: true },
                { key: 'recovery', name: 'recovery', critical: true },
                { key: 'userdata', name: 'data', critical: false },
                { key: 'cache', name: 'cache', critical: false },
                { key: 'cust', name: 'cust', critical: false }
            ];
            const stored = JSON.parse(localStorage.getItem('jx_partitions') || 'null');
            let partitions = stored || defaultPartitions;
            if (stored && !partitions.some(p => p.key === 'cust')) {
                partitions.push({ key: 'cust', name: 'cust', critical: false });
                localStorage.setItem('jx_partitions', JSON.stringify(partitions));
            }
            const list = container.querySelector('#part-list');
            const render = () => {
                list.innerHTML = '';
                partitions.forEach(p => {
                    const li = document.createElement('li');
                    li.className = 'part-item';
                    li.innerHTML = `<div class="part-name">${p.name} <span class="part-tag ${p.critical?'danger':''}">${p.critical?'CRITICAL':''}</span></div>
                    <div class="part-actions">
                        <button class="btn-opt" data-action="opt" data-key="${p.key}">Оптимизировать</button>
                        ${p.key==='cust' ? `<button class="btn-opt" data-action="clean" data-key="${p.key}">Очистить мусор</button>` : ''}
                        <button class="btn-del" data-action="del" data-key="${p.key}">Удалить</button>
                    </div>`;
                    list.appendChild(li);
                });
            };
            const save = () => localStorage.setItem('jx_partitions', JSON.stringify(partitions));
            const initializeFlashHexIfMissing = () => {
                let hex = localStorage.getItem('jx_flash_hex');
                if (!hex || typeof hex !== 'string' || hex.length < 512) {
                    const size = 256;
                    const bytes = new Uint8Array(size);
                    const header = 'BRICKED!';
                    for (let i = 0; i < header.length; i++) bytes[i] = header.charCodeAt(i);
                    hex = Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join('');
                    localStorage.setItem('jx_flash_hex', hex);
                }
            };
            const softBrick = () => {
                localStorage.setItem('jx_soft_bricked', 'true');
                initializeFlashHexIfMissing();
                showNotification('Устройство окирпичено');
                setTimeout(() => rebootDevice(false), 800);
            };
            list.onclick = (e) => {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                const key = btn.dataset.key;
                const idx = partitions.findIndex(p => p.key === key);
                if (idx === -1) return;
                if (btn.dataset.action === 'del') {
                    if (!confirm(`Удалить раздел "${partitions[idx].name}"?`)) return;
                    const wasCritical = partitions[idx].critical;
                    partitions.splice(idx, 1);
                    save();
                    render();
                    if (wasCritical) softBrick();
                    else showNotification('Раздел удалён');
                } else if (btn.dataset.action === 'opt') {
                    showNotification('Оптимизация выполнена');
                } else if (btn.dataset.action === 'clean') {
                    localStorage.setItem('jx_cust_cleaned_at', String(Date.now()));
                    showNotification('Мусор в разделе cust очищен');
                }
            };
            render();
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const choiceModal=document.getElementById('device-choice-modal'), pcChoiceBtn=document.getElementById('pc-choice'), mobileChoiceBtn=document.getElementById('mobile-choice'), bootScreen=document.getElementById('boot-screen'), androidContainer=document.getElementById('android-container'), timeElem=document.getElementById('time'), appIcons=document.querySelectorAll('.app-icon'), appWindow=document.getElementById('app-window'), appHeaderContainer=document.getElementById('app-header-container'), appContent=document.getElementById('app-content'), homeBtn=document.getElementById('home-btn'), backBtn=document.getElementById('back-btn'), physicalPowerBtn=document.getElementById('physical-power-button'), desktop=document.getElementById('desktop'), aodScreen=document.getElementById('aod-screen'), aodTime=document.getElementById('aod-time'), aodDate=document.getElementById('aod-date');
        
        if (localStorage.getItem('jmail_installed') === 'true') document.querySelector('.app-icon[data-app="JMail"]').dataset.installed = 'true';
        const jxManagerIcon = document.querySelector('.app-icon[data-app="JxManager"]');
        if (jxManagerIcon && localStorage.getItem('jxmanager_installed') === 'true') jxManagerIcon.dataset.installed = 'true';

        const openApp = (appName) => {
            const icon = document.querySelector(`.app-icon[data-app="${appName}"]`);
            const isInstalled = icon ? icon.dataset.installed !== 'false' : true;
            if (!isInstalled) { showNotification('Приложение не установлено. Скачайте его в JxMarket.'); return; }
            currentAppName = appName;
            const appTitle = icon ? icon.querySelector('span').textContent : appName;
            appHeaderContainer.innerHTML = `<div class="app-header"><span id="app-title">${appTitle}</span></div>`;
            appContent.innerHTML = '';
            appWindow.classList.remove('hidden', 'closing');
            if (appRenderers[appName]) appRenderers[appName](appContent);
            else appContent.innerHTML = `<p style="padding:20px;">Приложение "${appName}" находится в разработке.</p>`;
        };

        const closeApp = () => {
            if (appWindow.classList.contains('hidden')) return;
            if (currentAppName === 'Player' && playerAudio && !playerAudio.paused) playerAudio.pause();
            appWindow.classList.add('closing');
            appWindow.addEventListener('animationend', function handler() { appWindow.classList.add('hidden'); appContent.innerHTML = ''; currentAppName = null; appWindow.removeEventListener('animationend', handler); });
        };

        const updateAOD = () => { const now=new Date(); aodTime.textContent=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; aodDate.textContent=now.toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'}); };
        const turnScreenOn = () => { if (!isScreenOff) return; isScreenOff = false; aodScreen.classList.add('hidden'); desktop.style.filter = 'brightness(1)'; };
        const turnScreenOff = () => { if (isScreenOff) return; isScreenOff = true; closeApp(); updateAOD(); aodScreen.classList.remove('hidden'); desktop.style.filter = 'brightness(0.3)'; };

        physicalPowerBtn.addEventListener('mousedown', (e) => { e.preventDefault(); powerPressTimer = setTimeout(() => rebootDevice(false), 4000); });
        physicalPowerBtn.addEventListener('mouseup', () => { clearTimeout(powerPressTimer); isScreenOff ? turnScreenOn() : turnScreenOff(); });
        physicalPowerBtn.addEventListener('mouseleave', () => clearTimeout(powerPressTimer));
        aodScreen.addEventListener('click', turnScreenOn);

        const updateClock = () => { const now = new Date(); timeElem.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; };
        
        const startBootSequence = () => {
            choiceModal.classList.add('hidden');
            bootScreen.classList.remove('hidden');
            setTimeout(() => {
                const isSoftBricked = localStorage.getItem('jx_soft_bricked') === 'true';
                const isFrpLocked = localStorage.getItem('jx_frp_locked') === 'true';
                const rebootToTwrp = localStorage.getItem('reboot_to_twrp') === 'true';
                if (isSoftBricked) {
                    const hex = localStorage.getItem('jx_flash_hex') || '';
                    const isRestored = hex.startsWith('524553544F524544');
                    if (!isRestored) {
                        document.body.innerHTML = `
                        <div style="position:fixed;inset:0;background:#000;color:#f44336;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Roboto,sans-serif;text-align:center;padding:20px;">
                            <div style="font-size:28px;margin-bottom:10px;">JXOS Corrupted</div>
                            <div style="max-width:560px;color:#eee;margin-bottom:16px;">Система повреждена из-за удаления критических разделов.</div>
                            <div style="max-width:560px;color:#ff8a80;margin-bottom:20px;">Восстановление возможно только путём правки HEX флеш-образа:</div>
                            <div style="max-width:620px;background:#111;border:1px solid #333;border-radius:6px;color:#ccc;padding:12px;text-align:left;">
                                <div style="margin-bottom:8px;">1) Экспортируйте значение flash HEX:</div>
                                <code style="display:block;word-break:break-all;color:#9cf;">${hex}</code>
                                <div style="margin-top:8px;">2) Измените первые 8 байт на строку "RESTORED" в HEX (52 45 53 54 4F 52 45 44).</div>
                                <div>3) Вставьте изменённое значение ниже и нажмите Проверить.</div>
                                <div style="display:flex;gap:8px;margin-top:10px;">
                                    <input id="hex-input" style="flex:1;background:#000;border:1px solid #444;border-radius:4px;color:#eee;padding:8px;font-family:monospace;" placeholder="вставьте изменённый HEX..."/>
                                    <button id="hex-verify" style="background:#33b5e5;color:#000;border:0;border-radius:6px;padding:8px 12px;font-weight:700;cursor:pointer;">Проверить</button>
                                </div>
                                <div id="hex-msg" style="margin-top:8px;color:#aaa;"></div>
                            </div>
                        </div>`;
                        document.getElementById('hex-verify').onclick = () => {
                            const input = (document.getElementById('hex-input') || {}).value || '';
                            const msg = document.getElementById('hex-msg');
                            if (!/^([0-9a-fA-F]{2})+$/.test(input)) { msg.textContent = 'Неверный формат HEX'; return; }
                            if (!input.startsWith('524553544F524544')) { msg.textContent = 'HEX не содержит метку RESTORED'; return; }
                            localStorage.setItem('jx_flash_hex', input);
                            localStorage.removeItem('jx_soft_bricked');
                            localStorage.removeItem('jx_partitions');
                            msg.style.color = '#99cc00';
                            msg.textContent = 'HEX принят, восстановление...';
                            setTimeout(() => rebootDevice(true), 700);
                        };
                        return;
                    }
                }
                if (isFrpLocked) {
                    document.body.innerHTML = `
                    <div style="position:fixed;inset:0;background:#000;color:#ff8a80;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Roboto,sans-serif;text-align:center;padding:20px;">
                        <div style="font-size:28px;margin-bottom:10px;">FRP LOCK</div>
                        <div style="max-width:560px;color:#eee;margin-bottom:16px;">Это устройство заблокировано, так как было сброшено с привязанным аккаунтом JxMarket.</div>
                        <div style="max-width:620px;background:#111;border:1px solid #333;border-radius:6px;color:#ccc;padding:12px;text-align:left;">
                            Условия разблокировки: необходимо удалить ровно 4 правильных файла из набора из 1000 файлов.
                            <div style=\"margin-top:10px\"><button id=\"frp-start\" style=\"background:#33b5e5;color:#000;border:0;border-radius:6px;padding:8px 12px;font-weight:700;cursor:pointer;\">Начать</button></div>
                        </div>
                    </div>`;
                    document.getElementById('frp-start').onclick = () => {
                        const pool = Array.from({length:1000}, (_,i)=>({name:`file_${String(i+1).padStart(4,'0')}.bin`, safe: false}));
                        const chosen = new Set();
                        while (chosen.size < 4) chosen.add(Math.floor(Math.random()*1000));
                        [...chosen].forEach(i=>pool[i].safe=true);
                        localStorage.setItem('jx_frp_pool', JSON.stringify(pool.map(f=>({n:f.name,s:f.safe?1:0}))));
                        renderFrpTool();
                    };
                    const renderFrpTool = () => {
                        const raw = JSON.parse(localStorage.getItem('jx_frp_pool')||'[]');
                        const files = raw.map(x=>({name:x.n, safe:!!x.s}));
                        document.body.innerHTML = `
                        <div style="position:fixed;inset:0;background:#000;color:#fff;display:flex;flex-direction:column;font-family:Roboto,sans-serif;">
                            <div style="padding:12px 16px;border-bottom:1px solid #333;">FRP File Remover</div>
                            <div style="flex:1;overflow:auto;padding:10px 16px;">
                                <div style="color:#aaa;margin-bottom:10px;">Удалите ровно 4 файла. Подсказок нет.</div>
                                <div id="frp-list" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;"></div>
                            </div>
                            <div style="padding:10px 16px;border-top:1px solid #333;display:flex;gap:8px;align-items:center;">
                                <button id="frp-reset" style="background:#444;color:#fff;border:0;border-radius:4px;padding:8px 12px;cursor:pointer;">Сброс набора</button>
                                <div id="frp-msg" style="color:#aaa;"></div>
                            </div>
                        </div>`;
                        const list = document.getElementById('frp-list');
                        const msg = document.getElementById('frp-msg');
                        const renderList = () => {
                            list.innerHTML='';
                            files.forEach((f,idx)=>{
                                const btn = document.createElement('button');
                                btn.textContent = f.name;
                                btn.style.cssText = 'background:#111;color:#ddd;border:1px solid #333;border-radius:4px;padding:8px;cursor:pointer;text-align:left;';
                                btn.onclick = () => {
                                    const removed = files.splice(idx,1)[0];
                                    localStorage.setItem('jx_frp_pool', JSON.stringify(files.map(x=>({n:x.name,s:x.safe?1:0}))));
                                    const removedCount = (parseInt(localStorage.getItem('jx_frp_removed_count')||'0') + (removed.safe?1:0));
                                    localStorage.setItem('jx_frp_removed_count', String(removedCount));
                                    renderList();
                                    if (removedCount === 4) {
                                        localStorage.removeItem('jx_frp_locked');
                                        localStorage.removeItem('jx_frp_removed_count');
                                        localStorage.removeItem('jx_frp_pool');
                                        msg.style.color = '#99cc00';
                                        msg.textContent = 'Удалены 4 правильных файла. Разблокировка...';
                                        setTimeout(() => rebootDevice(true), 800);
                                    }
                                };
                                list.appendChild(btn);
                            });
                        };
                        renderList();
                        document.getElementById('frp-reset').onclick = () => {
                            localStorage.removeItem('jx_frp_removed_count');
                            const pool = Array.from({length:1000}, (_,i)=>({name:`file_${String(i+1).padStart(4,'0')}.bin`, safe: false}));
                            const chosen = new Set(); while (chosen.size < 4) chosen.add(Math.floor(Math.random()*1000));
                            [...chosen].forEach(i=>pool[i].safe=true);
                            localStorage.setItem('jx_frp_pool', JSON.stringify(pool.map(f=>({n:f.name,s:f.safe?1:0}))));
                            renderFrpTool();
                        };
                    };
                    return;
                }
                bootScreen.classList.add('hidden');
                androidContainer.classList.remove('hidden');
                desktop.style.backgroundImage = `url('${localStorage.getItem('desktop_wallpaper') || 'images/wp1.jpg'}')`;
                document.documentElement.style.setProperty('--animation-speed', localStorage.getItem('animation_speed') || 1);
                updateClock();
                setInterval(updateClock, 30000);
                if (rebootToTwrp) {
                    localStorage.removeItem('reboot_to_twrp');
                    setTimeout(() => {
                        openApp('TWRP');
                        showNotification('Загрузка в TWRP');
                    }, 300);
                }
            }, 3500);
        };

        const updatePcScale = () => {
            androidContainer.style.transform = 'none';
            if (!document.body.classList.contains('pc-view')) { desktop.style.transform = ''; return; }
            const scale = Math.min(window.innerWidth / 360, window.innerHeight / 640) * 0.95;
            const clamped = Math.max(0.5, Math.min(scale, 2));
            desktop.style.transformOrigin = 'center center';
            desktop.style.transform = `scale(${clamped.toFixed(2)})`;
        };

        pcChoiceBtn.addEventListener('click', () => {
            localStorage.setItem('view_mode', 'pc');
            document.body.classList.add('pc-view');
            updatePcScale();
            startBootSequence();
        });
        mobileChoiceBtn.addEventListener('click', () => {
            localStorage.setItem('view_mode', 'mobile');
            document.body.classList.remove('pc-view');
            updatePcScale();
            startBootSequence();
        });
        window.addEventListener('resize', updatePcScale);

        const savedView = localStorage.getItem('view_mode');
        if (savedView === 'pc' || savedView === 'mobile') {
            if (savedView === 'pc') document.body.classList.add('pc-view'); else document.body.classList.remove('pc-view');
            updatePcScale();
            startBootSequence();
        }
        appIcons.forEach(icon => icon.addEventListener('click', () => openApp(icon.dataset.app)));
        homeBtn.addEventListener('click', closeApp);
        backBtn.addEventListener('click', closeApp);
    });
    </script>
</body>
</html>
